---
title: "report.Rmd"
author: "cb"
date: "2022-11-27"
output: html_document
---

```{r setup, include=FALSE}
library(targets)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

```{r read_data}
d <- tar_read(d_modeling)
```

```{r descriptives, cache=TRUE}

# Size
nrow(d)

d %>% 
  filter(is_edchatde) %>% 
  nrow()

d %>% 
  filter(is_twlz) %>% 
  nrow()

# First tweet
d$created_at %>% min()

# Last Tweets
d$created_at %>% max()

tab <- d %>%
    distinct(user_id, .keep_all = TRUE) %>%
    filter(is_edchatde_member) %>% 
    pull(user_switched) %>%
    table()

# Users that switched
round(tab[2] / sum(tab), 4) * 100

twlz_users <- d$user_id[d$is_twlz_member] %>% unique()
edchat_users <- d$user_id[d$is_edchatde_member] %>% unique()

# N users stats
length(edchat_users)
length(twlz_users)
```



```{r mosaic_plot, cache=TRUE}

d_user <- d %>%
  distinct(user_id, .keep_all = TRUE)

xtabs(~ twlz_member_group + edchatde_member_group, d_user) %>%
  mosaicplot(shade = TRUE)

xtabs(~ twlz_member_group + edchatde_member_group, d_user)

chisq.test(d_user$twlz_member_group, d_user$edchatde_member_group)

```

```{r modeling, cache=TRUE}

d_user <- d %>%
  distinct(user_id, .keep_all = TRUE) %>%
  filter(!is.na(user_switched))

var_space <- c(
  "user_switched",
  "edchatde_member_group",
  "user_total_tweet_count",
  "n_interactions_edchat",
  "user_lifespan_days",
  "user_following_count",
  "user_followers_count",
  "user_tweets_per_day",
  "is_teacher",
  "centrality_degree",
  "centrality_closeness",
  "centrality_betweenness",
  "centrality_eigen",
  "repost_count"#,
  #"n_lag_posted_tweets_all",
  #"n_lag_posted_tweets_original",
  #"n_lag_likes",
  #"n_lag_reposts",
  #"n_lag_replies",
  #"n_lag_convs",
  #"n_lag_mentions",
  #"n_lag_interactions"
)

d_model <- d_user %>%
  select(!!var_space) %>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  drop_na()

# Log centralities
d_model$centrality_degree <- d_model$centrality_degree %>% log()
d_model$centrality_closeness <- d_model$centrality_closeness %>% log()
d_model$centrality_betweenness <- d_model$centrality_betweenness %>% log()
d_model$centrality_eigen <- d_model$centrality_eigen %>% log()

d_model$centrality_degree[is.infinite(d_model$centrality_degree)] <- 0
d_model$centrality_betweenness[is.infinite(d_model$centrality_betweenness)] <- 0
d_model$centrality_eigen[is.infinite(d_model$centrality_eigen)] <- 0
d_model$centrality_closeness[is.infinite(d_model$centrality_closeness)] <- 0

# Standardize predictors to ease interpretation
d_model <- d_model %>%
  mutate_if(is.numeric, scale)

# Fit + Searcg
m <- glm(user_switched ~ ., d_model, family = "binomial")
mm <- MASS::stepAIC(m, direction = 'backward')
sjPlot::tab_model(mm)

plot(mm)


```

